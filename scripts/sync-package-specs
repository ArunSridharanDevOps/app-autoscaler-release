#!/bin/bash
set -e


export GOPATH=$PWD/src/app-autoscaler
export PATH=$GOPATH/bin:$PATH

go get github.com/vito/gosub

if [ ! $(which gosub) ]; then
    echo "Gosub required to update dependencies in bosh/*/spec files."
    echo 'Please install with `go get github.com/vito/gosub`'
    exit 1
fi


function sync_package() {
  bosh_pkg=${1}

  shift

  (
    set -e

    cd packages/${bosh_pkg}

    {
      cat spec | grep -v '# gosub'
      gosub list "$@" | \
        sed -e 's|\(.*\)|- app-autoscaler/src/\1/*.go # gosub|g'
    } > spec.new

    mv spec.new spec
  )
}

sync_package metricscollector -app  autoscaler/metricscollector/... 
sync_package eventgenerator -app  autoscaler/eventgenerator/... 
sync_package scalingengine -app  autoscaler/scalingengine/... 
sync_package pruner -app  autoscaler/pruner/... 

git diff --name-only packages/metricscollector/spec packages/eventgenerator/spec \
          packages/scalingengine/spec packages/pruner/spec